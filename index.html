<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UI Kit 0 – Demo</title>

  <link rel="stylesheet" href="./src/ui-kit-0.css" />

  <!-- Third-party (offline, lokal) -->
  <script src="./src/third_party/ajv2020.js"></script>

  <!-- Optional: Chart.js UMD (falls du es lokal ablegst)
       Erwartet: window.Chart -->
  <!-- <script src="./src/third_party/chart.umd.js"></script> -->
</head>

<body>
<script type="module">
  import * as UI from "./src/ui-kit-0.js";

  // -----------------------
  // App Root
  // -----------------------
  const app = new UI.VGrid().appendTo(document.body);

  const header = document.createElement("div");
  header.innerHTML = `
    <h1 style="margin:0;">UI Kit 0 – Demo</h1>
    <div class="muted">
      UI-Kit läuft. Ajv/Chart optional. (Ajv: ${!!(window.Ajv2020 || window.ajv2020)} / Chart: ${!!window.Chart})
    </div>
  `;
  app.el.appendChild(header);

  const row = new UI.HGrid().appendTo(app);

  const left = new UI.Card().appendTo(row);
  const mid  = new UI.Card().appendTo(row);
  const right= new UI.Card().appendTo(row);

  left.el.style.flex = "1 1 340px";
  mid.el.style.flex  = "1 1 420px";
  right.el.style.flex= "1 1 420px";

  // -----------------------
  // Store
  // -----------------------
  const store = new UI.Store({
    clicks: 0,
    name: "Alice",
    agree: true,
    role: "dev",
    age: 31,
    people: [
      { id: 1, name: "Alice", age: 31, active: true },
      { id: 2, name: "Bob", age: 24, active: false },
      { id: 3, name: "Carla", age: 29, active: true },
    ],
    config: {
      refreshSeconds: 5,
      featureX: false
    }
  });

  // -----------------------
  // Left: Controls
  // -----------------------
  left.el.innerHTML = `<div style="font-weight:600; margin-bottom:8px;">Controls</div>`;

  const btnRow = new UI.HGrid().appendTo(left);

  new UI.Button("Click +1").appendTo(btnRow).onClick(() => {
    store.setPath("clicks", (store.get().clicks || 0) + 1);
  });

  new UI.Button("Reset", { variant: "secondary" }).appendTo(btnRow).onClick(() => {
    store.merge({ clicks: 0 });
  });

  new UI.Button("Danger", { variant: "danger" }).appendTo(btnRow).onClick(() => {
    alert("Danger button demo");
  });

  // Form grid
  const form = document.createElement("div");
  form.className = "field";
  form.style.marginTop = "12px";
  left.el.appendChild(form);

  // Name
  form.appendChild(Object.assign(document.createElement("div"), { className: "ui-label", textContent: "Name" }));
  const nameField = new UI.TextField("", { placeholder: "Name…" }).appendTo(form);
  nameField.bind(store, "name");

  // Role (Select)
  form.appendChild(Object.assign(document.createElement("div"), { className: "ui-label", textContent: "Role" }));
  const roleSelect = new UI.Select({
    options: [
      { value: "dev", label: "Developer" },
      { value: "ops", label: "Ops" },
      { value: "pm",  label: "Product" },
    ],
    placeholder: "Bitte wählen…",
  }).appendTo(form);
  roleSelect.bind(store, "role");

  // Age (typed Select demo)
  form.appendChild(Object.assign(document.createElement("div"), { className: "ui-label", textContent: "Age (typed)" }));
  const ageSelect = new UI.Select({
    options: [18, 24, 29, 31, 42, 55],
    parse: (s) => (s === "" ? null : Number(s)),
    format: (v) => (v == null ? "" : String(v)),
    placeholder: "–",
  }).appendTo(form);
  ageSelect.bind(store, "age");

  // Checkbox normal
  form.appendChild(Object.assign(document.createElement("div"), { className: "ui-label", textContent: "Active (box)" }));
  const agreeBox = new UI.Checkbox(false).appendTo(form);
  agreeBox.bind(store, "agree");

  // Checkbox slider
  form.appendChild(Object.assign(document.createElement("div"), { className: "ui-label", textContent: "Feature X (slider)" }));
  const fx = new UI.Checkbox(false, { slider: true }).appendTo(form);
  fx.bind(store, "config.featureX");

  // Add person
  new UI.Button("Add Person", { variant: "secondary" }).appendTo(left).onClick(() => {
    const s = store.get();
    const nextId = Math.max(...s.people.map(p => p.id)) + 1;
    store.setPath("people", [
      ...s.people,
      { id: nextId, name: s.name || `User${nextId}`, age: s.age ?? 0, active: !!s.agree }
    ]);
  });

  // -----------------------
  // Mid: Table
  // -----------------------
  mid.el.innerHTML = `<div style="font-weight:600; margin-bottom:8px;">Table</div>`;

  const table = new UI.TableView({
    columns: [
      { key: "id", label: "ID", align: "right" },
      { key: "name", label: "Name" },
      { key: "age", label: "Age", align: "right" },
      { key: "active", label: "Active", align: "center", format: v => v ? "✓" : "—" }
    ]
  }).appendTo(mid);

  table.bind(store, "people");

  // -----------------------
  // Right: JSON editor (Schema validation) + Debug view + Optional Chart
  // -----------------------
  right.el.innerHTML = `<div style="font-weight:600; margin-bottom:8px;">JSON / Validation / Debug</div>`;

  // Schema for config object
  const schema = {
    type: "object",
    properties: {
      refreshSeconds: { type: "integer", minimum: 1, maximum: 3600 },
      featureX: { type: "boolean" }
    },
    required: ["refreshSeconds", "featureX"],
    additionalProperties: false
  };

  // If Ajv isn't loaded, JsonTextEditor will currently throw via makeValidator().
  // (After you apply the validation.js fix, it will work with window.ajv2020.)
  let editor;
  try {
    editor = new UI.JsonTextEditor({
      schema,
      initialValue: store.get().config,
      onChange: (data, res) => {
        // Only apply if valid AND parsed
        if (res?.ok) store.setPath("config", data);
      }
    }).appendTo(right);

    editor.onValid((data) => {
      // keep UI in sync if someone edits config elsewhere
      // (optional: you can call editor.setValue(store.get().config) on subscribe)
    });
  } catch (e) {
    const msg = document.createElement("div");
    msg.className = "ui-help error";
    msg.textContent = String(e.message || e);
    right.el.appendChild(msg);
  }

  // Debug state
  const pre = document.createElement("pre");
  pre.style.margin = "0";
  pre.style.whiteSpace = "pre-wrap";
  pre.style.background = "var(--ui-bg-muted)";
  pre.style.padding = "10px";
  pre.style.borderRadius = "8px";
  right.el.appendChild(pre);

  store.subscribe((s) => {
    pre.textContent = JSON.stringify(s, null, 2);
  });

  // Optional Chart
  if (window.Chart) {
    const chart = new UI.ChartView({
      type: "bar",
      data: { labels: ["Clicks"], datasets: [{ label: "clicks", data: [0] }] },
      options: { responsive: true }
    }).appendTo(right);

    chart.bind(store, (s) => ({
      labels: ["Clicks"],
      datasets: [{ label: s.name || "clicks", data: [s.clicks || 0] }]
    }));
  } else {
    const hint = document.createElement("div");
    hint.className = "ui-help";
    hint.textContent = "Chart: nicht geladen (optional third_party/chart.umd.js).";
    right.el.appendChild(hint);
  }
</script>
</body>
</html>